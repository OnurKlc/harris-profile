<div class="container">
    <table class="score-table">
        <thead>
        <tr class="includeInCSV">
            <th style='visibility:collapse'></th>
            <th>
                <div contenteditable class="editable">Type concept title</div>
            </th>
            <th>
                <div contenteditable class="editable">Type concept title</div>
            </th>
            <th>
                <div contenteditable class="editable">Type concept title</div>
            </th>
        </tr>
        <tr class="height: 20px">
            <th style='visibility:collapse'></th>
        </tr>
        <tr>
            <th style='visibility:collapse'></th>
            <th style="padding: 0; height: 40px;">
                <div class="header-points">
                    <span>-2</span>
                    <span>-1</span>
                    <span>+1</span>
                    <span>+2</span>
                </div>
            </th>
            <th style="padding: 0; height: 40px">
                <div class="header-points">
                    <span>-2</span>
                    <span>-1</span>
                    <span>+1</span>
                    <span>+2</span>
                </div>
            </th>
            <th style="padding: 0; height: 40px">
                <div class="header-points">
                    <span>-2</span>
                    <span>-1</span>
                    <span>+1</span>
                    <span>+2</span>
                </div>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="firstRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable" style="min-width: 60px">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="secondRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="thirdRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="fourtRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="fifthRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)" id="sixthRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>

        <tr draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"
            id="seventhRow"
            class="includeInCSV">
            <td class="firstColumn">
                <div contenteditable class="editable">Type your criteria</div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
            <td style="padding: 0">
                <div class="header-points">
                    <span data-id="-2"></span>
                    <span data-id="-1"></span>
                    <span data-id="+1"></span>
                    <span data-id="+2"></span>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="buttons">
        <button class="refresh-button" onclick="refreshScores()">
            <span>Clear All Scores</span>
            <span class="hover-icon">
            <svg xmlns="http://www.w3.org/2000/svg" height="12px" viewBox="0 -960 960 960" width="12px" fill="#FFFFFF">
                <path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
            </svg>
            </span>
            <span class="stable-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="12px" viewBox="0 -960 960 960" width="12px" fill="#000000"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>
            </span>
        </button>
        <button class="export-button" onclick="exportTable()">
            <span>Export</span>
            <span class="hover-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="12px" viewBox="0 -960 960 960" width="12px" fill="#FFFFFF"><path
                      d="M240-40q-33 0-56.5-23.5T160-120v-440q0-33 23.5-56.5T240-640h120v80H240v440h480v-440H600v-80h120q33 0 56.5 23.5T800-560v440q0 33-23.5 56.5T720-40H240Zm200-280v-447l-64 64-56-57 160-160 160 160-56 57-64-64v447h-80Z" /></svg>
            </span>
            <span class="stable-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="12px" viewBox="0 -960 960 960" width="12px" fill="#000000"><path d="M240-40q-33 0-56.5-23.5T160-120v-440q0-33 23.5-56.5T240-640h120v80H240v440h480v-440H600v-80h120q33 0 56.5 23.5T800-560v440q0 33-23.5 56.5T720-40H240Zm200-280v-447l-64 64-56-57 160-160 160 160-56 57-64-64v447h-80Z"/></svg>
            </span>
        </button>
    </div>
</div>
<script>
    const dragIcon = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <mask id="mask0_156_389" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="20" height="20">
                        <rect width="20" height="20" fill="#D9D9D9"/>
                        </mask>
                        <g mask="url(#mask0_156_389)">
                        <path d="M7.49558 15.6795C7.17001 15.6795 6.89278 15.5636 6.66387 15.3317C6.43499 15.0999 6.32054 14.8212 6.32054 14.4956C6.32054 14.17 6.43647 13.8928 6.66831 13.6639C6.90015 13.435 7.17885 13.3206 7.50442 13.3206C7.82999 13.3206 8.10722 13.4365 8.33613 13.6683C8.56501 13.9002 8.67946 14.1789 8.67946 14.5044C8.67946 14.83 8.56353 15.1072 8.33169 15.3361C8.09985 15.565 7.82115 15.6795 7.49558 15.6795ZM12.4956 15.6795C12.17 15.6795 11.8928 15.5636 11.6639 15.3317C11.435 15.0999 11.3205 14.8212 11.3205 14.4956C11.3205 14.17 11.4365 13.8928 11.6683 13.6639C11.9001 13.435 12.1788 13.3206 12.5044 13.3206C12.83 13.3206 13.1072 13.4365 13.3361 13.6683C13.565 13.9002 13.6795 14.1789 13.6795 14.5044C13.6795 14.83 13.5635 15.1072 13.3317 15.3361C13.0999 15.565 12.8212 15.6795 12.4956 15.6795ZM7.49558 11.1795C7.17001 11.1795 6.89278 11.0635 6.66387 10.8317C6.43499 10.5999 6.32054 10.3212 6.32054 9.9956C6.32054 9.67003 6.43647 9.39279 6.66831 9.16389C6.90015 8.935 7.17885 8.82056 7.50442 8.82056C7.82999 8.82056 8.10722 8.93648 8.33613 9.16833C8.56501 9.40016 8.67946 9.67886 8.67946 10.0044C8.67946 10.33 8.56353 10.6072 8.33169 10.8361C8.09985 11.065 7.82115 11.1795 7.49558 11.1795ZM12.4956 11.1795C12.17 11.1795 11.8928 11.0635 11.6639 10.8317C11.435 10.5999 11.3205 10.3212 11.3205 9.9956C11.3205 9.67003 11.4365 9.39279 11.6683 9.16389C11.9001 8.935 12.1788 8.82056 12.5044 8.82056C12.83 8.82056 13.1072 8.93648 13.3361 9.16833C13.565 9.40016 13.6795 9.67886 13.6795 10.0044C13.6795 10.33 13.5635 10.6072 13.3317 10.8361C13.0999 11.065 12.8212 11.1795 12.4956 11.1795ZM7.49558 6.67947C7.17001 6.67947 6.89278 6.56355 6.66387 6.3317C6.43499 6.09987 6.32054 5.82117 6.32054 5.4956C6.32054 5.17003 6.43647 4.89279 6.66831 4.66389C6.90015 4.435 7.17885 4.32056 7.50442 4.32056C7.82999 4.32056 8.10722 4.43648 8.33613 4.66833C8.56501 4.90016 8.67946 5.17886 8.67946 5.50443C8.67946 5.83 8.56353 6.10724 8.33169 6.33614C8.09985 6.56503 7.82115 6.67947 7.49558 6.67947ZM12.4956 6.67947C12.17 6.67947 11.8928 6.56355 11.6639 6.3317C11.435 6.09987 11.3205 5.82117 11.3205 5.4956C11.3205 5.17003 11.4365 4.89279 11.6683 4.66389C11.9001 4.435 12.1788 4.32056 12.5044 4.32056C12.83 4.32056 13.1072 4.43648 13.3361 4.66833C13.565 4.90016 13.6795 5.17886 13.6795 5.50443C13.6795 5.83 13.5635 6.10724 13.3317 6.33614C13.0999 6.56503 12.8212 6.67947 12.4956 6.67947Z" fill="black" fill-opacity="0.3"/>
                        </g>
                    </svg>`

    document.querySelectorAll('.firstColumn').forEach(element => {
        const icon = document.createElement('div');
        icon.innerHTML = dragIcon;
        icon.style.cursor = 'grab';
        element.insertBefore(icon, element.firstChild);
    });

    document.querySelectorAll('.editable').forEach(element => {
        element.addEventListener('keypress', function (e) {
            console.log(this.innerText.length);
            if (this.innerText.length > 18) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    });

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text")
        const sourceRow = document.getElementById(data)
        const targetRow = ev.target.parentNode.closest('tr')
        const targetIndex = Array.from(targetRow.parentNode.children).indexOf(targetRow)
        const sourceIndex = Array.from(sourceRow.parentNode.children).indexOf(sourceRow)
        if (sourceIndex === targetIndex) {
            return
        } else if (sourceIndex < targetIndex) {
            targetRow.after(sourceRow)
        } else {
            targetRow.before(sourceRow)
        }
    }

    function clearColors(target) {
        const list = target.parentElement.children
        for (let span of list) {
            span.style.backgroundColor = 'transparent'
        }
    }

    document.addEventListener('click', function (e) {
        if (e.target && e.target.tagName === 'SPAN') {
            clearColors(e.target)
            if (e.target.dataset.id === '-2') {
                e.target.nextElementSibling.style.backgroundColor = 'rgb(253, 33, 37)';
                e.target.style.backgroundColor = 'rgb(253, 33, 37)';
            } else if (e.target.dataset.id === '-1') {
                e.target.style.backgroundColor = 'rgb(253, 33, 37)';
            } else if (e.target.dataset.id === '+1') {
                e.target.style.backgroundColor = 'rgb(36, 140, 41)';
            } else if (e.target.dataset.id === '+2') {
                e.target.previousElementSibling.style.backgroundColor = 'rgb(36, 140, 41)';
                e.target.style.backgroundColor = 'rgb(36, 140, 41)';
            }
        }
    })

    function refreshScores() {
        const spans = document.querySelectorAll('span')
        for (let span of spans) {
            span.style.backgroundColor = 'transparent'
        }
    }

    function exportTable() {
        const table = document.querySelector('.score-table');
        const json = {
            headers: [],
            rows: []
        };

        // Get headers
        const headers = table.querySelectorAll('thead th .editable');
        headers.forEach(header => {
            json.headers.push(header.innerText);
        });

        // Get rows
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const rowData = {
                criteria: '',
                scores: []
            };
            const criteria = row.querySelector('.firstColumn .editable');
            if (criteria) {
                rowData.criteria = criteria.innerText;
            }
            const scores = row.querySelectorAll('.header-points span');
            scores.forEach(score => {
                rowData.scores.push({
                    value: score.dataset.id,
                    color: score.style.backgroundColor === 'rgb(36, 140, 41)' ? 'green' : score.style.backgroundColor === 'rgb(253, 33, 37)' ? 'red' : 'transparent'
                });
            });
            json.rows.push(rowData);
        });
        parent.postMessage({pluginMessage: {type: 'export', data: json}}, '*');
    }
</script>
<style>
    :root {
        --green: rgb(36, 140, 41);
        --red: rgb(253, 33, 37);
    }

    * {
        box-sizing: border-box;
        font-weight: 400 !important;
        font-size: 12px;
    }

    .container {
        width: 738px;
        margin: 0 auto;
        padding: 20px;
        font-family: sf-apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 12px;
        color: #000000;
        font-weight: 400;
    }

    .score-table {
        table-layout: fixed;
        width: 698px;
        border-collapse: separate;
        border-spacing: 20px 0;
        color: #000000;
    }

    .firstColumn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
    }

    .firstColumn img {
        cursor: grab;
    }

    tbody tr,
    tbody td,
    .includeInCSV {
        height: 36px;
    }

    th:first-of-type {
        width: 160px;
    }

    th .editable {
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .editable {
        padding: 3px 5px;
        max-width: 140px;
        white-space: nowrap;
    }

    .editable:focus {
        outline: none;
        border: 1px solid #000000;
    }

    .header-points {
        display: flex;
        justify-content: space-between;
        height: calc(100%);
    }

    .header-points span {
        width: 25%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid rgb(204, 204, 204);
        border-bottom: none;
        border-top: none;
        border-collapse: collapse;
    }

    .header-points span:first-child {
        border-left: none;
    }

    .header-points span:last-child {
        border-right: none;
    }

    .score-table th,
    .score-table td {
        border: 1px solid #ccc;
        text-align: center;
        background-color: #F5F5F5;
    }

    .buttons {
        display: flex;
        flex: 1;
        justify-content: space-between;
        margin-top: 20px;
        padding: 0 10px;
    }

    .refresh-button,
    .export-button {
        background-color: #F5F5F5;
        padding: 10px 20px;
        margin: 0 10px;
        cursor: pointer;
        border-radius: 5px;
        border: 1px solid rgb(204, 204, 204);
        display: flex;
        justify-content: center;
        align-items: center;
        color: #000000;
    }

    .refresh-button:hover, .export-button:hover {
        background-color: #BCBCBC;
        color: #F5F5F5;
    }

    .refresh-button .hover-icon {
        display: none;
    }

    .refresh-button:hover .hover-icon {
        display: flex;
        border-color: #F5F5F5;
    }

    .refresh-button:hover span {
        color: #F5F5F5;
    }

    .refresh-button .stable-icon {
        display: flex;
    }

    .refresh-button:hover .stable-icon {
        display: none;
    }

    .export-button .hover-icon {
        display: none;
    }

    .export-button:hover .hover-icon {
        display: flex;
        border-color: #F5F5F5;
    }

    .export-button:hover span {
        color: #F5F5F5;
    }

    .export-button .stable-icon {
        display: flex;
    }

    .export-button:hover .stable-icon {
        display: none;
    }

    .stable-icon, .hover-icon {
        display: inline-flex;
        width: 20px;
        height: 20px;
        align-items: center;
        justify-content: center;
        border: 1px solid #000000;
        border-radius: 50%;
        margin-left: 10px;
    }
</style>
